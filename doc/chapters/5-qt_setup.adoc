////
  Copyright NXP 2020-2021
  Author: Rogerio Silva <rogerio.silva@nxp.com>
  Author: Marco Franchi <marco.franchi@nxp.com>
  Author: Michael Pontikes <michael.pontikes_1@nxp.com>
  Author: Frank Wang <lei.wang_15@nxp.com>
  Author: Steve Liu <chen.liu_1@nxp.com>
////

[appendix]
== Qt Creator Setup

Qt is a cross-platform application framework that is widely used for developing
application software that can be run on various software and hardware platforms
with little or no change in the underlying codebase, while still being a native
application with native capabilities and speed. It is used in a wide array of
embedded use cases, such as TVs, cars, and 3D printers. This section introduces
how to setup the development environment to build a Qt application and deploy
it to the board running the NXP Linux BSP.

The QT ecosystem provides an SDK to build powerful, connected and beautiful
applications that run on any screen and across any platform. Here for embedded
development, we need the following tools:

- Qt Creator IDE
- Qt source code
- HOST build toolchain
- TARGET build toolchain

Qt Creator is a cross-platform C++, JavaScript and QML integrated development
environment which is part of the SDK for the Qt GUI Application development
framework. It includes a visual debugger and an integrated GUI layout and forms
designer. It can run on both Windows, MacOS and Linux, developer create a Qt
application on PC HOST and debug the UI on HOST build with HOST toolchain
firstly. When debug completed, developer could use TARGET toolchain to build
the application, and deploy the binary to embedded system like i.MX boards

The HOST toolchain would be downloaded with the SDK, but the TARGET toolchain
is downloaded by Yocto introduced below.

[IMPORTANT%autofit]
To be able to used the cross-compile toolchain, you MUST use a Linux host
machine to run Qt Creator and the i.MX Qt SDK.

=== Install Qt SDK

Online or offline installer for Linux version can be found on:
https://www.qt.io/download-open-source

[WARNING%autofit]
Read the website before you decide to use this version of Qt! The open source
version of the Qt has certain license requirements that you must follow!

. Grant the executable permission to this binary, and run it.
+
----
$ chmod +x qt-unified-linux-<...>.run
$ ./qt-unified-linux-<...>.run
----
+
. If you do not have a QT account, just create one. Otherwise login with your
account, then "Next".
+
. After all the packages downloaded and installed, you can run the Qt Creator by:
+
----
$ <Qt install dir>/Tools/QtCreator/bin/qtcreator
----

You would be able to open the examples in the Qt source code and quickly use
the HOST toolchain to build and run a example on the PC.

=== Setting up the Yocto BSP

. Please first follow the instructions in Chapter 2 on how to build the {NAME} up
to before the 4th step (bitbake ...). After creating the build folder, add the
following lines to the <YOCTO_BUILD_FOLDER>/conf/local.conf file.
+
----
EXTRA_IMAGE_FEATURES ?= "debug-tweaks ssh-server-openssh"
IMAGE_INSTALL:append = "openssh-sftp openssh-sftp-server rsync"
----
+
. After this, run the command included on step 4.
+
----
$ bitbake imx-image-full
----
+
. Build the QT 5 or 6 target toolchain, which would be used in QT Creator to
build and deploy the QT application:
+
----
$ bitbake meta-toolchain-qt5
OR for 5.15.y+:
$ bitbake meta-toolchain-qt6
----

=== Deploy SDK and SD card image

Deploy the rootfs onto the board, and install the cross compile toolchain used
by Qt Creator onto the host computer. The install script for the cross compile
toolchain can be found under <YOCTO_BUILD_FOLDER>/tmp/deploy/sdk. The rootfs
file is in the same place as in Chapter 2.

=== Qt Creator Configuration

[NOTE%autofit]
====
The following steps contain various code snippets. Be aware that these code
snippets may vary depending on the local setup and the version used.
====

[TIP%autofit]
====
The following steps ask users to find a lot of user-defined file paths. It is
highly encouraged for users to make use of the `find` tool to on Linux. For
example, for the next step, change to the directory where the i.MX SDK is
installed and run `find -name "qmake".` Almost all files other then the
`mkspec` file should be found in the `pokysdk-linux` folder.
====

. Open the "Kits" settings from [Menu] -> [Tools] -> [Options...].
+
. Add the target's `qmake` executable to list of Qt versions
+
----
Possible path:
qmake: /opt/fsl-imx-xwayland/5.15-honister/sysroots/x86_64-pokysdk-linux/usr/bin/qmake
----
+
image::qtversion.png[pdfwidth=100%]
+
. Add the cross compile g++ and gcc to the list of compilers. The two toolchains should be in the same folder.
+
----
Possible paths:
GCC: /opt/fsl-imx-xwayland/5.15-honister/sysroots/x86_64-pokysdk-linux/usr/bin/aarch64-poky-linux/aarch64-poky-linux-gcc
G++: /opt/fsl-imx-xwayland/5.15-honister/sysroots/x86_64-pokysdk-linux/usr/bin/aarch64-poky-linux/aarch64-poky-linux-g++
----
+
image::qtcompilegcc.png[pdfwidth=100%]
+
. Add the SDK's `GDB` tool to the list of debuggers:
+
----
Possible path:
GDB: /opt/fsl-imx-xwayland/5.15-honister/sysroots/x86_64-pokysdk-linux/usr/bin/aarch64-poky-linux/aarch64-poky-linux-gdb
----
+
image::debugger.png[pdfwidth=100%]
+
. Go to devices and add the i.MX 8 device. You will need the board's IP address. 
+
image::remotedevice.png[pdfwidth=100%]
+
. Go back to Kits and create a kit with the SDK's toolchains and i.MX device. The mkspec and sysroot paths are required as well.
+
----
Possible paths:
sysroot: /opt/fsl-imx-xwayland/5.15-honister/sysroots/cortexa53-crypto-poky-linux
mkspec: /opt/fsl-imx-xwayland/5.15-honister/sysroots/cortexa53-crypto-poky-linux/usr/lib/mkspecs/linux-arm-gnueabi-g++
----
+
image::kits.png[pdfwidth=100%]
+
. Update the qmake.conf file to include new toolchain. The file is located in the `sysroot` folder above.
+
----
Possible changes:

include(../common/g++-unix.conf)
# modifications to g++.conf
-QMAKE_CC                = arm-linux-gnueabi-gcc
-QMAKE_CXX               = arm-linux-gnueabi-g++
-QMAKE_LINK              = arm-linux-gnueabi-g++
-QMAKE_LINK_SHLIB        = arm-linux-gnueabi-g++
+QMAKE_CC                = aarch64-poky-linux-gcc
+QMAKE_CXX               = aarch64-poky-linux-g++
+QMAKE_LINK              = aarch64-poky-linux-g++
+QMAKE_LINK_SHLIB        = aarch64-poky-linux-g++
+
+QMAKE_LFLAGS += --sysroot=/opt/fsl-imx-xwayland/5.15-honister/sysroots/cortexa53-crypto-poky-linux
# modifications to linux.conf
-QMAKE_AR                = arm-linux-gnueabi-ar cqs
-QMAKE_OBJCOPY           = arm-linux-gnueabi-objcopy
-QMAKE_NM                = arm-linux-gnueabi-nm -P
-QMAKE_STRIP             = arm-linux-gnueabi-strip
+QMAKE_AR                = aarch64-poky-linux-gcc-ar  cqs
+QMAKE_OBJCOPY           = aarch64-poky-linux-objcopy
+QMAKE_NM                = aarch64-poky-linux-nm -P
+QMAKE_STRIP             = aarch64-poky-linux-strip
 load(qt_config)
----

=== Configure the project

The following settings need to completed for each project created in Qt
Creator to run on the i.MX board.

. Once the project is opened, go to the Projects tab and add the created kit to the project.
+
. Next, modify the `project.pro` file. The below `INCLUDEPATH` and `DEFINES` lines must be added and point to your cross compile headers. The `target.path` and `INSTALLS` path is are optional lines to specify the location of the install.
+
----
Possible changes:

target.path = /home/root/temp 
INSTALLS += target
INCLUDEPATH += /opt/fsl-imx-xwayland/5.15-honister/sysroots/aarch64-poky-linux/usr/include/c++/11.2.0/
INCLUDEPATH += /opt/fsl-imx-xwayland/5.15-honister/sysroots/aarch64-poky-linux/usr/include/c++/11.2.0/aarch64-poky-linux/
INCLUDEPATH += /opt/fsl-imx-xwayland/5.15-honister/sysroots/aarch64-poky-linux/usr/include/
DEFINES += __ARM_PCS_VFP
----
+
. Clicking the "Run" button on the bottom left of the screen should run the Qt application on the board.

=== Changes for 32 bits (e.g. i.MX7ULP)

In case the project is being built for a 32-bits SoC like i.MX7ULP, The following change on qmake.conf must be done.

----
#
# qmake configuration for building with arm-poky-linux-gnueabi-g++
#

MAKEFILE_GENERATOR = UNIX
CONFIG += incremental
QMAKE_INCREMENTAL_STYLE = sublib

include(../common/linux.conf)
include(../common/gcc-base-unix.conf)
include(../common/g++-unix.conf)

# modifications to g++.conf
QMAKE_CC = arm-poky-linux-gnueabi-gcc
QMAKE_CXX = arm-poky-linux-gnueabi-g++
QMAKE_LINK = arm-poky-linux-gnueabi-g++
QMAKE_LINK_SHLIB = arm-poky-linux-gnueabi-g++

QMAKE_LFLAGS += --sysroot=/opt/fsl-imx-xwayland/5.15-honister/sysroots/cortexa7hf-neon-poky-linux-gnueabi -mfloat-abi=hard -mfpu=neon-vfpv4
QMAKE_CXXFLAGS += -mfloat-abi=hard -mfpu=neon-vfpv4

# modifications to linux.conf
QMAKE_AR = arm-poky-linux-gnueabi-ar cqs
QMAKE_OBJCOPY = arm-poky-linux-gnueabi-objcopy
QMAKE_NM = arm-poky-linux-gnueabi-nm -P
QMAKE_STRIP = arm-poky-linux-gnueabi-strip
load(qt_config)
----

<<<
